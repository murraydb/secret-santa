-- Active: 1695868201355@@192.168.86.41@5432@secret_santa@public
/*
**************************************

setup script

**************************************
*/
/*
create user santa with PASSWORD 'H0h1H1';
create user santa_dev with PASSWORD 'I1i1I1';

CREATE DATABASE secret_santa
    WITH
    OWNER = santadev
    ENCODING = 'UTF8'
    CONNECTION LIMIT = -1
    IS_TEMPLATE = False;

GRANT ALL ON DATABASE secret_santa TO santadev WITH GRANT OPTION;
GRANT TEMPORARY ON DATABASE secret_santa TO santadev;

*/
create table usr (
    usrUID INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1),
    usrCreateStamp TIMESTAMP not null DEFAULT now(),
    usrCreateBy int not null default 0, 
    usrModifiedTimestamp timestamp NOT NULL DEFAULT NOW(),
    usrModifiedBy int NOT NULL DEFAULT 0,
    usrState int not null DEFAULT 0
)

insert into usr (usrState) values (1)

select * from usr;



drop table usrData;
CREATE TABLE usrData (
  usrDataUID int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  usrUID INT NOT null,
  usrPassWord text not null,
  usrLogin text NOT NULL,
  usrDisplayName text NOT NULL,
  usrFirstName text NOT NULL,
  usrLastName text NOT NULL,
  usrModifiedTimestamp timestamp NOT NULL DEFAULT NOW(),
  usrModifiedBy int NOT NULL DEFAULT 0,
  usrFirstLoginTimestamp Timestamp,
  usrStatus int not null DEFAULT -1
);
insert into usrdata (usruid, usrpassword, usrlogin, usrdisplayname, usrfirstname, usrlastname, usrmodifiedby, usrstatus)
values (1, 'password', 'admin', '**ADMIN**', 'Rudolf', 'Reindeer', 0, 1);

CREATE OR REPLACE PROCEDURE public.usrcreate(IN vName text , IN vPassword text, in vCreatedBy int)
 LANGUAGE plpgsql
AS $procedure$
declare NewUser int;
declare NewUserUID int;
begin
    insert into usr (usrCreateBy, usrState) values (vCreatedBy, 1)  /*Defaults to New*/;
    commit;
    select  max(usruid) usruid  into NewUserUID from usr u;
   insert into usrdata (usruid, usrpassword, usrlogin, usrdisplayname, usrfirstname, usrlastname, usrmodifiedby, usrstatus)
   values (NewUserUID, vPassword, vName, vName, '**Default**', '**Default**', vCreatedBy, 1);
--    commit;
end;$procedure$;
commit;
/* 2023-09-26 20:43:16 [14 ms] */ 

;
/*
select * from usrdata;

select * from usr;

select * from usrdata ud inner join usr u on ud.usruid = u.usruid LIMIT 100 OFFSET 0;


 call usrcreate('999','password',1)

*/


